#include <stdio.h>
#include <string.h>
#include <time.h>
#include "md5.h"
#include "sha1.h"
#include "sha256.h"
#include "blake2b.h"

void md5(unsigned char *input, unsigned int inputlen, unsigned char *output) {
    MD5_CTX md5;

    MD5Init(&md5);         

    MD5Update(&md5,input,inputlen);

    MD5Final(&md5,output);

}

int sha1(const char *input, uint8_t output[20], unsigned size)
{
    int i, err;
    SHA1Context sha;

    err = SHA1Reset(&sha);
    err = SHA1Input(&sha,(const unsigned char *) input, size);
    if (err){
        printf("SHA1Input Error %d.\n", err);
        return -1;
    }
    err = SHA1Result(&sha, output);
    if (err){
        printf("SHA1Result Error %d, could not compute message digest.\n",err );
        return -1;
    } 
    return 0;
}


int main() {
    
    int chain_len = 1050000;    //the length of hash chain
    unsigned char seed[] = "admin";    //the seed

    int chain_loc[] = {1049875, 1046664, 1041029, 1039155, 1038360, 1037871, 1037131, 1036771, 1035871, 1035834, 1034396, 1028987, 1028026, 1026651, 1020734, 1019174, 1017700, 1003487, 1001994, 1000699, 989061, 986999, 984140, 983915, 979579, 974055, 972424, 972358, 971790, 970428, 968302, 963165, 961109, 960827, 958051, 952451, 949142, 948674, 948419, 946655, 946139, 945722, 940660, 940271, 934775, 930214, 926692, 924152, 918706, 916697, 911170, 907228, 906233, 900525, 898462, 893072, 891735, 890896, 890110, 883730, 882814, 882690, 875579, 873063, 869822, 862199, 860934, 859430, 852753, 850714, 845668, 844531, 843363, 838578, 836809, 835883, 831100, 824836, 824769, 824322, 821775, 820793, 818120, 816686, 815284, 813496, 812563, 811239, 807457, 806399, 805314, 797705, 796264, 796146, 791867, 785715, 782947, 781967, 778558, 776980, 775867, 775479, 774604, 770973, 767549, 758886, 755760, 751877, 746139, 742528, 740054, 739838, 739391, 727991, 723382, 720109, 711448, 707757, 704442, 704431, 703148, 701867, 699905, 694928, 693944, 693724, 691744, 690294, 689858, 689054, 681688, 678655, 666111, 665759, 661241, 658509, 656996, 651509, 650687, 649066, 648551, 648537, 646865, 643720, 643511, 641218, 640207, 638455, 637817, 635564, 635266, 634764, 627966, 627756, 619684, 610705, 606926, 596254, 595756, 592236, 591765, 588648, 587855, 587394, 585230, 584269, 581730, 569616, 569002, 563676, 559445, 558387, 555445, 554646, 554559, 554414, 553132, 551448, 550579, 546118, 544699, 544661, 538884, 534662, 533667, 533053, 532338, 531304, 530837, 527801, 527232, 523305, 521236, 519850, 516375, 514948, 509299, 500277, 497722, 495078, 490672, 488945, 487475, 487472, 487418, 486032, 480674, 479324, 477818, 476228, 467249, 465633, 461813, 449795, 446865, 445606, 442807, 441802, 440176, 437248, 429877, 416603, 415964, 412537, 412142, 411226, 406693, 405638, 402877, 401286, 400172, 400118, 398364, 395565, 394348, 394181, 393150, 392818, 385187, 381986, 378661, 364222, 363848, 359851, 352681, 352454, 349767, 346645, 341850, 339629, 337562, 337381, 328387, 327819, 320375, 319970, 317981, 316321, 312095, 311519, 310781, 310526, 310196, 307834, 293876, 292385, 291447, 287093, 282716, 281289, 281177, 276693, 276269, 275432, 272316, 270481, 269685, 269683, 260195, 251677, 250481, 246445, 243327, 239411, 235516, 230225, 220822, 210940, 205898, 203875, 198038, 197682, 197625, 197413, 192109, 188653, 181595, 180832, 176528, 174816, 167480, 162585, 160636, 159518, 155368, 153962, 141727, 138759, 137825, 133433, 132611, 132186, 129972, 120645, 115350, 114114, 107802, 106230, 106059, 102899, 99363, 91258, 90678, 88375, 83653, 82136, 74879, 73137, 68162, 65838, 64384, 56522, 52000, 51466, 44210, 41051, 33138, 33100, 32617, 28988, 27166, 26760, 21596, 21181, 19745, 19543, 5795};

    uint8_t blake_out[64];
    uint8_t sha256_out[SHA256_BYTES];
    uint8_t md5_out[16];
    uint8_t sha1_out[20];

    // int round = chain_len / 4;
    int i, j;
    clock_t start, end;
    double dura = 0;

    for (i = 0; i < 347; i++) {
        int round = chain_loc[i];
        start = clock();
        for (j = 0; j < round; ) {
            if (j == 0)
                md5(seed, strlen((char *)seed), md5_out);
            else
                md5(sha1_out, strlen((char *)sha1_out), md5_out);
            j++;
            if (j == round) break;

            sha256(md5_out, strlen((char *)md5_out), sha256_out);
            j++;
            if (j == round) break;

            blake2b(blake_out, 64, NULL, 0, sha256_out, strlen((char *)sha256_out));
            j++;
            if (j == round) break;

            sha1(blake_out, sha1_out, strlen((char *)blake_out));
            j++;
        }
        end = clock();
        dura = dura + (double) (end - start);
        printf("ROUUND %d COMPLETE...\n", i);
    }
    
    printf("Average passowrd generation time (Ours): %f seconds.\n", dura / CLOCKS_PER_SEC / 347);

    return 0;
}